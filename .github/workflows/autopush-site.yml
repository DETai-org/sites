name: Auto Push and Merge PR üß≠

on:
  workflow_dispatch:               # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  pull_request:
    branches: [main]               # <-- –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è PR, —Ü–µ–ª—è—â–∏—Ö—Å—è –≤ main
    types: [opened, synchronize, reopened]

# –¢–æ–∫–µ–Ω—É –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –Ω–∞ –º–µ—Ä–¥–∂ PR
permissions:
  pull-requests: write
  contents: read

jobs:
  autopush:
    # –í—ã–ø–æ–ª–Ω—è–µ–º job —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ PR –µ—Å—Ç—å –º–µ—Ç–∫–∞ [autopush-site]
    if: ${{ github.event.pull_request.body && contains(github.event.pull_request.body, '[autopush-site]') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        uses: actions/setup-node@v4
        with:
          node-version: '14'

      - name: Install dependencies
        run: |
          npm install || true

      - name: Run tests (–µ—Å–ª–∏ –µ—Å—Ç—å)
        run: |
          npm run test || true

      - name: Deploy (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        run: |
          npm run deploy || echo "skip deploy"

      - name: Merge Pull Request via REST API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          if [ -z "$PR_NUM" ] || [ "$PR_NUM" = "null" ]; then
            echo "No pull request number found, skipping merge."
            exit 0
          fi

          echo "Attempting to merge PR #$PR_NUM in repository $GITHUB_REPOSITORY ..."

          HTTP_CODE=$(curl -s -o /tmp/merge_resp -w "%{http_code}" -X PUT \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUM/merge" \
            -d '{"commit_title":"Automatic merge after autopush-site PR","merge_method":"merge"}')

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Merge succeeded (HTTP $HTTP_CODE)."
            cat /tmp/merge_resp
          else
            echo "Merge failed (HTTP $HTTP_CODE). Response:"
            cat /tmp/merge_resp
            exit 1
          fi
