name: Auto Push and Merge PR üß≠

on:
  workflow_dispatch:               # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  pull_request_target:
    branches: [main]
    types: [opened, synchronize, reopened]

# –¢–æ–∫–µ–Ω—É –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –Ω–∞ –º–µ—Ä–¥–∂ PR
permissions:
  pull-requests: write
  contents: read

jobs:
  # Job –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏/–¥–µ–ø–ª–æ—è ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ pull_request (–±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ–∫—Ä–µ—Ç–∞–º –¥–ª—è —Ñ–æ—Ä–∫–æ–≤)
  checks:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        uses: actions/setup-node@v4
        with:
          node-version: '14'

      - name: Install dependencies
        run: |
          npm install || true

      - name: Run tests (–µ—Å–ª–∏ –µ—Å—Ç—å)
        run: |
          npm run test || true

      - name: Deploy (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        run: |
          npm run deploy || echo "skip deploy"

  # –û—Ç–¥–µ–ª—å–Ω—ã–π job –¥–ª—è –º–µ—Ä–¥–∂–∞ ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ base-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (pull_request_target)
  # –í–∞–∂–Ω–æ: —Ç—É—Ç –º—ã –ù–ï –¥–µ–ª–∞–µ–º checkout PR-–∫–æ–¥–∞ ‚Äî —Ç–æ–ª—å–∫–æ –≤—ã–∑—ã–≤–∞–µ–º API –¥–ª—è –º–µ—Ä–∂–∞.
  automerge:
    needs: checks
    if: ${{ github.event.pull_request.body && contains(github.event.pull_request.body, '[autopush-site]') && github.event_name == 'pull_request_target' }}
    runs-on: ubuntu-latest
    steps:
      - name: Info
        run: |
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Repo: $GITHUB_REPOSITORY"
          echo "PR: ${{ github.event.pull_request.number }}"
          echo "PR head repo: ${{ github.event.pull_request.head.repo.full_name }}"
          echo "PR head ref: ${{ github.event.pull_request.head.ref }}"

      - name: Merge Pull Request via REST API (safe, no checkout)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUM: ${{ github.event.pull_request.number }}
        run: |
          if [ -z "$PR_NUM" ] || [ "$PR_NUM" = "null" ]; then
            echo "No pull request number found, skipping merge."
            exit 0
          fi

          echo "Attempting to merge PR #$PR_NUM in repository $GITHUB_REPOSITORY ..."

          RESP_FILE=$(mktemp)
          HTTP_CODE=$(curl -s -o "$RESP_FILE" -w "%{http_code}" -X PUT \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/${PR_NUM}/merge" \
            -d '{"commit_title":"Automatic merge after autopush-site PR","merge_method":"merge"}')

          echo "HTTP code: $HTTP_CODE"
          cat "$RESP_FILE" || true

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Merge succeeded (HTTP $HTTP_CODE)."
          else
            echo "Merge failed (HTTP $HTTP_CODE). See response above."
            # –ï—Å–ª–∏ 403 —Å "Resource not accessible by integration" ‚Äî –∑–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–∞–≤/–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—Å–º. –ø–æ—è—Å–Ω–µ–Ω–∏–µ –Ω–∏–∂–µ)
            exit 1
          fi
