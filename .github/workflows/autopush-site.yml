name: Auto Push and Merge PR ðŸ§­ Ð«

on:
  workflow_dispatch:               # Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  pull_request_target:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸/Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ðµ pull_request (Ð±ÐµÐ· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² Ð´Ð»ï¿½ï¿½ Ñ„Ð¾Ñ€ÐºÐ¾Ð²)
  checks:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
        uses: actions/setup-node@v4
        with:
          node-version: '14'

      - name: Install dependencies
        run: |
          npm install || true

      - name: Run tests (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
        run: |
          npm run test || true

      - name: Deploy (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
        run: |
          npm run deploy || echo "skip deploy"

  # ÐÐ²Ñ‚Ð¾Ð¼ÐµÑ€Ð´Ð¶ â€” Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ðµ base-Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ (pull_request_target).
  # ÐÐ• Ð´ÐµÐ»Ð°ÐµÑ‚ checkout PR-ÐºÐ¾Ð´Ð°, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð° Ð¸ Ð·Ð°Ñ‚ÐµÐ¼ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ merge Ñ‡ÐµÑ€ÐµÐ· REST API.
  automerge:
    if: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.body && contains(github.event.pull_request.body, '[autopush-site]') }}
    runs-on: ubuntu-latest
    steps:
      - name: Info
        run: |
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Repo: $GITHUB_REPOSITORY"
          echo "PR number: ${{ github.event.pull_request.number }}"
          echo "PR head sha: ${{ github.event.pull_request.head.sha }}"

      - name: Wait for required checks to become successful
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_SHA: ${{ github.event.pull_request.head.sha }}
          REPO: ${{ github.repository }}
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ combined status (state Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ: success, pending, failure)
          MAX_ATTEMPTS=12
          SLEEP_SECONDS=5
          i=1
          state=""
          echo "Checking combined status for commit $PR_SHA in $REPO"
          while [ $i -le $MAX_ATTEMPTS ]; do
            echo "Attempt $i/$MAX_ATTEMPTS..."
            resp=$(curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${REPO}/commits/${PR_SHA}/status")
            # Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ state Ð±ÐµÐ· jq
            state=$(echo "$resp" | sed -n 's/.*"state":"\([^"]*\)".*/\1/p' | head -n1)
            echo "Combined state: ${state}"
            if [ "$state" = "success" ]; then
              echo "All required checks are successful."
              break
            fi
            if [ "$state" = "failure" ] || [ "$state" = "error" ]; then
              echo "One or more checks failed or errored. Response:"
              echo "$resp"
              exit 1
            fi
            # pending or empty -> sleep and retry
            sleep $SLEEP_SECONDS
            i=$((i+1))
          done

          if [ "$state" != "success" ]; then
            echo "Checks did not reach success state within timeout (state=${state}). Aborting merge."
            exit 1
          fi

      - name: Merge Pull Request via REST API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUM: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          if [ -z "$PR_NUM" ] || [ "$PR_NUM" = "null" ]; then
            echo "No pull request number found, skipping merge."
            exit 0
          fi
          echo "Attempting to merge PR #$PR_NUM in repository $REPO ..."
          RESP_FILE=$(mktemp)
          HTTP_CODE=$(curl -s -o "$RESP_FILE" -w "%{http_code}" -X PUT \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/pulls/${PR_NUM}/merge" \
            -d '{"commit_title":"Automatic merge after autopush-site PR","merge_method":"merge"}')

          echo "HTTP code: $HTTP_CODE"
          cat "$RESP_FILE" || true

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Merge succeeded (HTTP $HTTP_CODE)."
          else
            echo "Merge failed (HTTP $HTTP_CODE). See response above."
            exit 1
          fi
